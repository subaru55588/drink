<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ä»Šæ—¥ä½ å–å“ªä¸€æ¯ï¼Ÿ</title>
  
  <!-- PWA è¨­å®šï¼šè®“å®ƒçœ‹èµ·ä¾†åƒåŸç”Ÿ App (iOS/Android æ”¯æ´) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="æ‰‹æ–é£²ç´€éŒ„">
  <meta name="theme-color" content="#FFFBEB"> <!-- å°æ‡‰ bg-amber-50 çš„é¡è‰² -->
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- è¼‰å…¥ Tailwind CSS (æ¨£å¼) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- è¼‰å…¥ React å’Œ ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- è¼‰å…¥ Babel (è®“ç€è¦½å™¨çœ‹å¾—æ‡‚ React ç¨‹å¼ç¢¼) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* ä¿®æ­£ iOS é»æ“Šé«˜äº®å•é¡Œ */
    * { -webkit-tap-highlight-color: transparent; }
    /* ç¢ºä¿å…¨è¢å¹•é«˜åº¦æ­£ç¢º */
    html, body { 
      height: 100%; 
      overscroll-behavior-y: none; /* é˜²æ­¢ä¸‹æ‹‰é‡æ•´ï¼Œè®“é«”é©—æ›´åƒ App */
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
  </style>
</head>
<body class="bg-amber-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      // --- ç‹€æ…‹ç®¡ç† ---
      const [currentDate, setCurrentDate] = useState(new Date());
      const [selectedDate, setSelectedDate] = useState(null);
      const [records, setRecords] = useState({});
      const [view, setView] = useState('calendar'); // 'calendar' or 'stats'
      const [isModalOpen, setIsModalOpen] = useState(false);

      // è¡¨å–®ç‹€æ…‹
      const [formData, setFormData] = useState({
        shop: '',
        item: '',
        price: '',
        ice: 'å¾®å†°',
        sugar: 'å¾®ç³–'
      });

      // --- é¸é …å®šç¾© ---
      const ICE_OPTIONS = ['æ­£å¸¸', 'å°‘å†°', 'å¾®å†°', 'å»å†°', 'å¸¸æº«', 'æº«'];
      const SUGAR_OPTIONS = ['å…¨ç³–', 'å°‘ç³–', 'åŠç³–', 'å¾®ç³–', 'ä¸€åˆ†ç³–', 'ç„¡ç³–'];

      // --- åˆå§‹åŒ–èˆ‡å„²å­˜ (LocalStorage) ---
      useEffect(() => {
        try {
          const savedRecords = localStorage.getItem('bobaRecords');
          if (savedRecords) {
            setRecords(JSON.parse(savedRecords));
          }
        } catch (error) {
          console.error("ç„¡æ³•è®€å–ç´€éŒ„:", error);
        }
      }, []);

      useEffect(() => {
        try {
          localStorage.setItem('bobaRecords', JSON.stringify(records));
        } catch (error) {
          console.error("ç„¡æ³•å„²å­˜ç´€éŒ„:", error);
        }
      }, [records]);

      // --- æ—¥æœŸè¼”åŠ©å‡½æ•¸ ---
      const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const days = new Date(year, month + 1, 0).getDate();
        const firstDay = new Date(year, month, 1).getDay();
        return { days, firstDay };
      };

      const formatDateKey = (date) => {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      };

      const handleDateClick = (day) => {
        const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        setSelectedDate(formatDateKey(date));
        setIsModalOpen(true);
        // é‡ç½®è¡¨å–®
        setFormData({ shop: '', item: '', price: '', ice: 'å¾®å†°', sugar: 'å¾®ç³–' });
      };

      const changeMonth = (offset) => {
        const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1);
        setCurrentDate(newDate);
      };

      // --- æ–°å¢ç´€éŒ„é‚è¼¯ ---
      const handleAddRecord = (e) => {
        e.preventDefault();
        if (!selectedDate) return;

        const currentRecords = records[selectedDate] || [];
        if (currentRecords.length >= 2) {
          alert("ç‚ºäº†å¥åº·è‘—æƒ³ï¼Œä¸€å¤©ä¸Šé™æ˜¯å…©æ¯å–”ï¼ğŸ¥¤");
          return;
        }

        const newRecord = {
          id: Date.now(),
          ...formData,
          price: Number(formData.price) || 0
        };

        setRecords({
          ...records,
          [selectedDate]: [...currentRecords, newRecord]
        });

        // Reset form but keep modal open so they can see it added
        setFormData({ shop: '', item: '', price: '', ice: 'å¾®å†°', sugar: 'å¾®ç³–' });
      };

      const handleDeleteRecord = (dateKey, id) => {
        const updatedDayRecords = records[dateKey].filter(r => r.id !== id);
        if (updatedDayRecords.length === 0) {
          const newRecords = { ...records };
          delete newRecords[dateKey];
          setRecords(newRecords);
        } else {
          setRecords({
            ...records,
            [dateKey]: updatedDayRecords
          });
        }
      };

      // --- çµ±è¨ˆè¨ˆç®— ---
      const calculateStats = () => {
        let totalCups = 0;
        let totalPrice = 0;
        let shopCounts = {};
        let iceCounts = {};
        let sugarCounts = {};

        Object.values(records).forEach(dayRecords => {
          dayRecords.forEach(record => {
            totalCups += 1;
            totalPrice += record.price;
            
            // çµ±è¨ˆåº—å®¶
            shopCounts[record.shop] = (shopCounts[record.shop] || 0) + 1;
            // çµ±è¨ˆç³–å†°
            iceCounts[record.ice] = (iceCounts[record.ice] || 0) + 1;
            sugarCounts[record.sugar] = (sugarCounts[record.sugar] || 0) + 1;
          });
        });

        const topShop = Object.entries(shopCounts).sort((a, b) => b[1] - a[1])[0];

        return { totalCups, totalPrice, topShop, iceCounts, sugarCounts };
      };

      // --- UI å…ƒä»¶ ---
      const CalendarView = () => {
        const { days, firstDay } = getDaysInMonth(currentDate);
        const blanks = Array(firstDay).fill(null);
        const dayArray = Array.from({ length: days }, (_, i) => i + 1);

        return (
          <div className="bg-white/80 backdrop-blur-md rounded-2xl p-4 shadow-xl border border-orange-100">
            <div className="flex justify-between items-center mb-6 px-2">
              <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-orange-100 rounded-full transition-colors font-bold text-orange-600">
                â—€
              </button>
              <h2 className="text-xl font-bold text-orange-800 tracking-wider">
                {currentDate.getFullYear()} å¹´ {currentDate.getMonth() + 1} æœˆ
              </h2>
              <button onClick={() => changeMonth(1)} className="p-2 hover:bg-orange-100 rounded-full transition-colors font-bold text-orange-600">
                â–¶
              </button>
            </div>

            <div className="grid grid-cols-7 gap-2 mb-2">
              {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => (
                <div key={d} className="text-center text-xs font-bold text-orange-400">{d}</div>
              ))}
            </div>

            <div className="grid grid-cols-7 gap-2">
              {blanks.map((_, i) => <div key={`blank-${i}`} className="h-24"></div>)}
              {dayArray.map(day => {
                const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayRecords = records[dateKey] || [];
                const isToday = formatDateKey(new Date()) === dateKey;

                return (
                  <div 
                    key={day} 
                    onClick={() => handleDateClick(day)}
                    className={`h-24 rounded-xl border flex flex-col items-center justify-start p-1 cursor-pointer transition-all active:scale-95
                      ${isToday ? 'border-orange-500 bg-orange-50 ring-2 ring-orange-200' : 'border-orange-100 bg-white hover:bg-orange-50'}
                    `}
                  >
                    <span className={`text-sm font-bold mb-1 ${isToday ? 'text-orange-600' : 'text-gray-500'}`}>{day}</span>
                    
                    {/* é£²æ–™åœ–ç¤º */}
                    <div className="flex flex-col gap-1 w-full px-1">
                      {dayRecords.map((rec, idx) => (
                        <div key={idx} className="h-6 w-full bg-orange-200 rounded-md flex items-center justify-center text-[10px] text-orange-800 truncate px-1 shadow-sm">
                          ğŸ¥¤ {rec.item}
                        </div>
                      ))}
                      {dayRecords.length === 0 && <div className="h-full flex items-center justify-center opacity-10 text-2xl">ğŸ§‹</div>}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      };

      const StatsView = () => {
        const stats = calculateStats();
        
        return (
          <div className="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-xl border border-orange-100 space-y-6">
            <h2 className="text-2xl font-bold text-orange-800 mb-4 flex items-center gap-2">
              ğŸ“Š å–é£²æ–™çµ±è¨ˆ
            </h2>

            <div className="grid grid-cols-2 gap-4">
              <div className="bg-orange-50 p-4 rounded-xl border border-orange-100">
                <div className="text-orange-400 text-sm mb-1 font-medium">ç¸½æ¯æ•¸</div>
                <div className="text-3xl font-bold text-orange-700">{stats.totalCups} <span className="text-base font-normal">æ¯</span></div>
              </div>
              <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                <div className="text-green-500 text-sm mb-1 font-medium">ç¸½èŠ±è²»</div>
                <div className="text-3xl font-bold text-green-700">${stats.totalPrice}</div>
              </div>
            </div>

            {stats.topShop && (
              <div className="bg-amber-50 p-4 rounded-xl border border-amber-100 flex items-center justify-between">
                <div>
                  <div className="text-amber-500 text-sm font-medium">æœ€å¸¸å–çš„åº—</div>
                  <div className="text-xl font-bold text-amber-800">{stats.topShop[0]}</div>
                </div>
                <div className="text-3xl font-bold text-amber-300">#{stats.topShop[1]}</div>
              </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="p-4 border rounded-xl">
                 <h3 className="text-sm font-bold text-gray-500 mb-3 flex items-center gap-1">ğŸ§Š å†°å¡Šåå¥½</h3>
                 <div className="space-y-2">
                    {Object.entries(stats.iceCounts).map(([k, v]) => (
                       <div key={k} className="flex justify-between text-sm">
                         <span>{k}</span>
                         <span className="font-bold text-orange-600">{v} æ¯</span>
                       </div>
                    ))}
                 </div>
              </div>
              <div className="p-4 border rounded-xl">
                 <h3 className="text-sm font-bold text-gray-500 mb-3 flex items-center gap-1">ğŸ’§ ç”œåº¦åå¥½</h3>
                 <div className="space-y-2">
                    {Object.entries(stats.sugarCounts).map(([k, v]) => (
                       <div key={k} className="flex justify-between text-sm">
                         <span>{k}</span>
                         <span className="font-bold text-orange-600">{v} æ¯</span>
                       </div>
                    ))}
                 </div>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-amber-50 via-orange-100 to-yellow-50 p-4 md:p-8 font-sans text-slate-700 pb-safe">
          <div className="max-w-md mx-auto relative">
            
            {/* Header */}
            <div className="flex justify-between items-center mb-6 pt-safe">
              <div>
                <h1 className="text-3xl font-black text-orange-900 tracking-tight">ä»Šæ—¥ä½ å–å“ªä¸€æ¯ï¼Ÿ</h1>
                <p className="text-orange-600/70 text-sm mt-1">ç´€éŒ„æ¯ä¸€æ»´å¿«æ¨‚</p>
              </div>
              <button 
                onClick={() => setView(view === 'calendar' ? 'stats' : 'calendar')}
                className="bg-white p-3 rounded-xl shadow-md text-orange-500 hover:text-orange-600 hover:shadow-lg transition-all text-xl"
              >
                {view === 'calendar' ? 'ğŸ“Š' : 'ğŸ“…'}
              </button>
            </div>

            {/* Main Content */}
            {view === 'calendar' ? <CalendarView /> : <StatsView />}

            {/* Modal for Adding Drinks */}
            {isModalOpen && (
              <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
                  <div className="bg-orange-500 p-4 flex justify-between items-center text-white">
                    <h3 className="font-bold text-lg">{selectedDate} é£²æ–™ç´€éŒ„</h3>
                    <button onClick={() => setIsModalOpen(false)} className="text-white hover:bg-orange-600 rounded-full p-1">âœ•</button>
                  </div>
                  
                  <div className="p-6 max-h-[80vh] overflow-y-auto">
                    {/* æ—¢æœ‰ç´€éŒ„åˆ—è¡¨ */}
                    <div className="space-y-3 mb-6">
                      {records[selectedDate]?.map((record) => (
                        <div key={record.id} className="bg-orange-50 p-3 rounded-xl flex justify-between items-center border border-orange-100">
                          <div>
                            <div className="font-bold text-orange-900">{record.shop} - {record.item}</div>
                            <div className="text-xs text-orange-600 mt-1">
                              {record.ice} â€¢ {record.sugar} â€¢ ${record.price}
                            </div>
                          </div>
                          <button 
                            onClick={() => handleDeleteRecord(selectedDate, record.id)}
                            className="text-red-300 hover:text-red-500 p-2"
                          >
                            ğŸ—‘ï¸
                          </button>
                        </div>
                      ))}
                      {(!records[selectedDate] || records[selectedDate].length === 0) && (
                        <p className="text-center text-gray-400 text-sm py-2">ä»Šå¤©é‚„æ²’å–é£²æ–™å–” (æˆ–æ˜¯é‚„æ²’ç´€éŒ„)</p>
                      )}
                    </div>

                    {/* æ–°å¢è¡¨å–® */}
                    {(records[selectedDate]?.length || 0) < 2 ? (
                      <form onSubmit={handleAddRecord} className="space-y-4 border-t pt-4">
                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="text-xs font-bold text-gray-500 mb-1 block">åº—å</label>
                            <input 
                              type="text" 
                              required
                              className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300"
                              placeholder="ä¾‹å¦‚ï¼š50åµ"
                              value={formData.shop}
                              onChange={e => setFormData({...formData, shop: e.target.value})}
                            />
                          </div>
                          <div>
                            <label className="text-xs font-bold text-gray-500 mb-1 block">å“é …</label>
                            <input 
                              type="text" 
                              required
                              className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300"
                              placeholder="ä¾‹å¦‚ï¼šå››å­£æ˜¥"
                              value={formData.item}
                              onChange={e => setFormData({...formData, item: e.target.value})}
                            />
                          </div>
                        </div>

                        <div>
                          <label className="text-xs font-bold text-gray-500 mb-1 block">åƒ¹æ ¼</label>
                          <div className="relative">
                            <span className="absolute left-3 top-2 text-gray-400">$</span>
                            <input 
                              type="number" 
                              required
                              className="w-full bg-gray-50 border border-gray-200 rounded-lg pl-8 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300"
                              placeholder="0"
                              value={formData.price}
                              onChange={e => setFormData({...formData, price: e.target.value})}
                            />
                          </div>
                        </div>

                        {/* å†°å¡Šé¸æ“‡ */}
                        <div>
                          <label className="text-xs font-bold text-gray-500 mb-2 flex items-center gap-1">ğŸ§Š å†°å¡Š</label>
                          <div className="grid grid-cols-3 gap-2">
                            {ICE_OPTIONS.map(opt => (
                              <button
                                key={opt}
                                type="button"
                                onClick={() => setFormData({...formData, ice: opt})}
                                className={`text-xs py-2 rounded-lg border transition-all
                                  ${formData.ice === opt 
                                    ? 'bg-blue-100 border-blue-300 text-blue-700 font-bold' 
                                    : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
                                  }`}
                              >
                                {opt}
                              </button>
                            ))}
                          </div>
                        </div>

                        {/* ç”œåº¦é¸æ“‡ */}
                        <div>
                          <label className="text-xs font-bold text-gray-500 mb-2 flex items-center gap-1">ğŸ’§ ç”œåº¦</label>
                          <div className="grid grid-cols-3 gap-2">
                            {SUGAR_OPTIONS.map(opt => (
                              <button
                                key={opt}
                                type="button"
                                onClick={() => setFormData({...formData, sugar: opt})}
                                className={`text-xs py-2 rounded-lg border transition-all
                                  ${formData.sugar === opt 
                                    ? 'bg-pink-100 border-pink-300 text-pink-700 font-bold' 
                                    : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
                                  }`}
                              >
                                {opt}
                              </button>
                            ))}
                          </div>
                        </div>

                        <button 
                          type="submit" 
                          className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-200 transform active:scale-95 transition-all flex items-center justify-center gap-2"
                        >
                          â• åŠ å…¥ç´€éŒ„
                        </button>
                      </form>
                    ) : (
                      <div className="bg-gray-100 rounded-xl p-4 text-center text-gray-500 text-sm mt-4">
                         ğŸ‰ ä»Šæ—¥æ‰£æ‰“å·²ç”¨å®Œ (ä¸Šé™ 2 æ¯)
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>
